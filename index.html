<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<title>Eat Bertie Bott's Every Flavor Beans</title>
<link href="https://fonts.googleapis.com/css?family=EB+Garamond|Henny+Penny" rel="stylesheet">
<link href="main.css?7" rel="stylesheet">

<body>

<header><h2>Bertie Bott's <span class="star">✶</span> Every Flavor Beans</h2></header>

<article>

<aside>
<div id="close-mobile-menu">×</div>
<h3>Hogwarts House</h3>
<p>
<select>
    <option value="">None
    <option value="gryffindor">Gryffindor
    <option value="slytherin">Slytherin
    <option value="ravenclaw">Ravenclaw
    <option value="hufflepuff">Hufflepuff
</select>
</p>
</aside>

<section>
<h4>✶ Appendix <abbr>i</abbr> ✶</h4>
<h1>The Package from Home</h1>

<main></main>

<fieldset>
    <p id="eat">
        <button onclick="chooseBean()">Eat a bean</button>
        <button onclick="end()">I've had enough</button>
    </p>
    <p id="open"><button onclick="openBag()">Open the box</button></p>
    <p id="play"><button onclick="play()">Read about another student.</button></p>
</fieldset>

</section>

</article>


<script>
var data, xhr = new XMLHttpRequest(), lineCount = 0, chosen = [], beanCount = 20, student = {};
xhr.open("GET", "flavors.json");
xhr.onload = function (e) {
    data = JSON.parse(xhr.response);

    var xhr2 = new XMLHttpRequest();
    xhr2.open("GET", "names.json");
    xhr2.onload = function (e2) {
        data.names = JSON.parse(xhr2.response);
        play();
        document.getElementById("open").style.display = "inline-block";
    }
    xhr2.send();
};
xhr.send();

Array.prototype.random = function () {
    return this[Math.floor(Math.random() * this.length)];
};

function total(flavor) {
    var tastes = flavor[Object.keys(flavor)[0]]
    return Object.keys(tastes).reduce(function (a, b) {
        return a + tastes[b];
    }, 0);
}

function showHideButtons(buttonToShow) {
    var buttons = document.querySelectorAll("fieldset p"), ii, display;
    for (ii = 0; ii < buttons.length; ii += 1) {
        display = (buttons[ii].id === buttonToShow) ? "inline-block" : "none";
        buttons[ii].style.display = display
    }
}

function desc(flavor) {
    var tastes = flavor[Object.keys(flavor)[0]];
    var tot = total(flavor);

    if (tastes.putrid > 1) {
        return ". It was the worst thing " + pronoun() + "'d even tasted";
    }
    if (tastes.hot > 1) {
        return ". It burned " + possessive() + " mouth";
    }
    if (tastes.sweet > 1) {
        if (Math.random() > 0.50) {
            return ". It was very sweet";
        }
        return ". It was quite sweet";
    }
    if (tastes.sour > 1) {
        return ". " + possessive(true) + " face puckered at how sour it was";
    }
    if (tastes.bitter > 1) {
        return ". It was unpleasantly bitter";
    }
    if (tastes.salty > 1) {
        return ". It was terribly too salty";
    }
    if (tastes.savory > 1) {
        if (Math.random() > 0.50) {
            return ". That was quite good";
        }
        return ". Mmm, that was satisfyingly savory";
    }

    if (total > 4) {
        return ". It was extremely flavorful";
    }
    if (tastes.sweet > 0 && tastes.sour > 0) {
        if (Math.random() > 0.50) {
            return ". It was pleasantly tangy";
        }
        return ". Tangy";
    }
    if (tastes.putrid > 0) {
        if (Math.random() > 0.50) {
            return ". A little weird, but OK";
        }
        return ". It was a bit funky-tasting";
    }
    if (tastes.hot > 0) {
        return ". It was mildly spicy";
    }
    if (tastes.sour > 0) {
        return ". It was a bit tart";
    }
    if (tastes.bitter > 0) {
        return ". It was slightly bitter";
    }
    if (tastes.savory > 0) {
        return ". It was not too bad";
    }
    if (tastes.sweet > 0) {
        return ". It was mildly sweet";
    }
    if (tastes.salty > 0) {
        return ". Salty";
    }

    if (total === 0) {
        return ". It was surprisingly bland";
    }

    if (Math.random() > 0.50) {
        return ". It was OK";
    }
    return ". Meh";
}

function typewrite(text) {
    var p = document.querySelector("main p:last-child"), ii;
    var buttons = document.querySelectorAll("fieldset button");

    if (!text) {
        for (ii = 0; ii < buttons.length; ii += 1) {
            buttons[ii].disabled = false;
        }
    } else {
        p.appendChild(document.createTextNode(text.slice(0, 1)));
        window.setTimeout(
            function () {
                typewrite(text.slice(1));
                document.querySelector("fieldset").scrollIntoView(false);
            }, 20
        );
    }
}

function startwriting(text) {
    var buttons = document.querySelectorAll("fieldset button"), ii;
    for (ii = 0; ii < buttons.length; ii += 1) {
        buttons[ii].disabled = true;
    }
    typewrite(text);
}

function chooseBean() {
    var flavor = data.flavors.random();
    chosen.push(flavor);
    write(flavor);
}

function write(flavor) {
    var beanName = Object.keys(flavor)[0],
        putrid = flavor[beanName].putrid,
        main = document.querySelector("main"),
        text = ". It tasted like ",
        description = desc(flavor);

    if (lineCount >= beanCount - 1) {
        main.appendChild(document.createElement("p"));
        startwriting("The last bean in the box was " + beanName + "-flavored" + description + ". " + student.given + " looked forward to eating more");
        showHideButtons("play");
        return;
    }
    if (lineCount === 0) {
        text = ". The first bean tasted like "
    }
    if (lineCount === 1) {
        text = ". " + student.given + " dared to try another. This one tasted like ";
    }
    if (lineCount === 2) {
        main.appendChild(document.createElement("p"));
        text = "Undeterred, " + pronoun() + " dug into the box again. The next one tasted like "
    }
    if (lineCount === 3) {
        text = ". " + student.given + " tasted beans the flavor of ";
        description = "";
    }
    if (lineCount > 3) {
        text = ", ";
        if (lineCount == beanCount - 2) {
            text = ", and ";
        }
        description = "";
    }
    if (putrid > 1) {
        main.appendChild(document.createElement("p"));

        startwriting("Ugh! That one was " + beanName + "-flavored. " + student.given + " spit it out and is done eating Bertie Bott's for a long while")
        showHideButtons("play");
    } else {
        startwriting(text + beanName + description);
    }

    lineCount += 1;
}

function pronoun(capitalize) {
    if (student.gender == "male") {
        if (capitalize) {
            return "He";
        }
        return "he";
    }
    if (capitalize) {
        return "She";
    }
    return "she";
}

function possessive(capitalize) {
    if (student.gender == "male") {
        if (capitalize) {
            return "His";
        }
        return "his";
    }
    if (capitalize) {
        return "Her";
    }
    return "her";
}

function openBag() {
    showHideButtons("eat");
    startwriting(". " + pronoun(true) + " opened the box and searched for the most delicious-looking color");
}

function end() {
    document.querySelector("main").appendChild(document.createElement("p"));
    startwriting(student.given +  " closed the box. Maybe " + pronoun() + "'ll try more later");
    showHideButtons("play");
}

function play() {
    var p = document.createElement("p"),
        main = document.querySelector("main");

    student.gender = (Math.random() > 0.50) ? "male" : "female";
    student.sur = data.names.sur.random();
    student.given = data.names[student.gender].random();

    main.innerHTML = "";
    lineCount = 0;
    showHideButtons("open");
    p.textContent = student.given + " " + student.sur + " waited for the first delivery since " + pronoun() + " started school at Hogwarts. " + pronoun(true) + " gently removed the package from the owl's leg, then tore into the brown paper. Inside was a small box of " + beanCount + " Bertie Bott's Every Flavor Beans";
    main.appendChild(p);
}

function setHouse() {
    var className = location.hash,
        html = document.querySelector("html");

    if (className) {
        html.className = className.slice(1);
    } else {
        html.className = "";
    }
}
window.onhashchange = setHouse;
window.onload = function () {
    if (location.hash) {
        document.querySelector("select").value = location.hash.slice(1);
    }
    setHouse();
}
document.querySelector("select").onchange = function () {
    location.href = "#" + this.value;
};
</script>
